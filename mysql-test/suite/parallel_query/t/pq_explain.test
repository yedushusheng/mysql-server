# support spceify shard_key in comment for spider
--disable_warnings
--source ../include/init_spider.inc
--source ../include/pq_default.inc

# issue 1039: read invalid timing data on leader because missing some nodes data in workers.
# create spider table
--echo create spider tables
let create_table_sql=CREATE TABLE t1(id int primary key auto_increment, a char(1));
let shardkey=id;
--source include/create_spider_table.inc
show create table t1;

INSERT INTO t1 (a) VALUES ('A'),('B'),('A'),('B'),('A'),('B'),(NULL),('a'),('b'),(NULL),('A'),('B'),(NULL);

# For now, analyze in parallel is not supported yet.
# --replace_regex /time=\d+\.\d+\.\.\d+\.\d+\/\d+\.\d+\.\.\d+\.\d+ rows=\d+\/\d+/time=N.NNN..N.NNN\/N.NNN..N.NNN rows=NNN\/NNN/ /time=\d+\.\d+\.\.\d+\.\d+/time=N.NNN..N.NNN/
--replace_regex /time=\d+\.\d+\.\.\d+\.\d+/time=N.NNN..N.NNN/
EXPLAIN ANALYZE SELECT a FROM t1 GROUP BY a;
--replace_regex /time=\d+\.\d+\.\.\d+\.\d+/time=N.NNN..N.NNN/
EXPLAIN ANALYZE SELECT a FROM t1 GROUP BY a;
--replace_regex /time=\d+\.\d+\.\.\d+\.\d+/time=N.NNN..N.NNN/
EXPLAIN ANALYZE SELECT count(*) FROM t1 GROUP BY a order by a;
--replace_regex /time=\d+\.\d+\.\.\d+\.\d+/time=N.NNN..N.NNN/
EXPLAIN ANALYZE SELECT count(*) FROM t1 WHERE id > 5 GROUP BY a order by a;
--replace_regex /time=\d+\.\d+\.\.\d+\.\d+/time=N.NNN..N.NNN/
EXPLAIN ANALYZE SELECT avg(id) FROM t1 WHERE id > 5 GROUP BY a order by a;
--replace_regex /time=\d+\.\d+\.\.\d+\.\d+/time=N.NNN..N.NNN/
EXPLAIN ANALYZE SELECT sum(id), count(id), avg(id) FROM t1 WHERE id > 5 GROUP BY a order by a;
--replace_regex /time=\d+\.\d+\.\.\d+\.\d+/time=N.NNN..N.NNN/
EXPLAIN ANALYZE SELECT sum(id), count(id), avg(id) FROM t1 WHERE id > 5 GROUP BY a order by a LIMIT 1;

# issue #1186: crash EXPLAIN tree for query with UNION
EXPLAIN format=tree SELECT * FROM t1 UNION SELECT * FROM t1;
--replace_regex /time=\d+\.\d+\.\.\d+\.\d+/time=N.NNN..N.NNN/
EXPLAIN ANALYZE SELECT * FROM t1 UNION SELECT * FROM t1;

let drop_table_name=t1;
--source include/drop_spider_table.inc

# clean env.
--source ../include/deinit_spider.inc
--enable_warnings
